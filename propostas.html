<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Propostas Recebidas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .aprovado { color: green; font-weight: bold; }
    .vencedor-badge { background-color: green; color: rgb(255, 255, 255); font-weight: bold; padding: 2px 8px; border-radius: 5px; margin-left: 8px; }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-4">
    <h2 class="mb-3">Propostas Recebidas</h2>

    <div class="input-group mb-3">
      <input type="text" class="form-control" placeholder="Buscar por nome ou CNPJ" id="busca">
      <button class="btn btn-outline-secondary" onclick="filtrar()">Buscar</button>
    </div>

    <ul class="list-group" id="listaPropostas"></ul>
  </div>

  <script>
    const propostas = {
      "001": [
        { nome: "Empresa A", cnpj: "12.345.678/0001-00", valor: "R$ 18.000,00", status: "aprovado" },
        { nome: "Empresa B", cnpj: "98.765.432/0001-11", valor: "R$ 17.500,00", status: "pendente" },
        { nome: "Empresa C", cnpj: "11.222.333/0001-44", valor: "R$ 19.000,00", status: "pendente" }
      ],
      "002": [
        { nome: "Construtora BR", cnpj: "88.765.432/0001-10", valor: "R$ 11.000,00", status: "pendente" },
        { nome: "Reforma Pronta", cnpj: "33.333.333/0001-33", valor: "R$ 10.800,00", status: "pendente" }
      ],
      "003": [
        { nome: "SoftEdu", cnpj: "44.444.444/0001-44", valor: "R$ 38.500,00", status: "pendente" },
        { nome: "EduTech Brasil", cnpj: "55.555.555/0001-55", valor: "R$ 37.000,00", status: "pendente" }
      ],
      "004": [
        { nome: "Construtora Alpha", cnpj: "01.234.567/0001-99", valor: "R$ 72.000,00", status: "aprovado", vencedor: true },
        { nome: "Construtora Beta", cnpj: "98.765.432/0001-88", valor: "R$ 75.000,00", status: "aprovado" }
      ]
    };

    const pregoes = {
      "001": { status: "aberto" },
      "002": { status: "aberto" },
      "003": { status: "aberto" },
      "004": { status: "fechado", vencedor: "Construtora Alpha" }
    };

    function carregarPropostas() {
      const id = new URLSearchParams(window.location.search).get("id");
      const lista = document.getElementById("listaPropostas");
      const dados = propostas[id] || [];
      const statusPregao = pregoes[id] ? pregoes[id].status : "aberto";

      const existeVencedor = dados.some(p => p.vencedor);

      lista.innerHTML = dados.map((p, i) => {
        const podeEleger = p.status === 'aprovado' && !p.vencedor && !existeVencedor;
        return `
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div><strong>${p.nome}</strong> (${p.cnpj})
                ${p.vencedor ? '<span class="vencedor-badge">Vencedora</span>' : ''}
              </div>
              <div>Valor: ${p.valor}</div>
              <div>Status: ${p.status === 'aprovado' ? '<span class=\"aprovado\">Aprovado</span>' : 'Pendente'}</div>
            </div>
            <div>
              ${statusPregao === "aberto" && p.status === 'pendente' ? `
                <button class="btn btn-success btn-sm me-1" onclick="aprovar(${i}, '${id}')">Aprovar</button>
                <button class="btn btn-danger btn-sm" onclick="rejeitar(${i}, '${id}')">Rejeitar</button>
              ` : ''}
              ${podeEleger ? `
                <button class="btn btn-success btn-sm mt-1" onclick="elegerVencedor(${i}, '${id}')">Eleger Vencedor</button>
              ` : ''}
            </div>
          </li>
        `;
      }).join('');
    }

    function aprovar(index, id) {
      if (confirm("Deseja aprovar esta proposta?")) {
        propostas[id][index].status = 'aprovado';
        carregarPropostas();
      }
    }

    function rejeitar(index, id) {
      if (confirm("Tem certeza que deseja rejeitar esta proposta?")) {
        propostas[id].splice(index, 1);
        carregarPropostas();
      }
    }

    function elegerVencedor(index, id) {
      if (confirm("Confirmar esta proposta como vencedora? Isso não poderá ser desfeito.")) {
        propostas[id].forEach(p => delete p.vencedor);
        propostas[id][index].vencedor = true;
        alert("Proposta marcada como vencedora (simulação)");
        carregarPropostas();
      }
    }

    function filtrar() {
      const termo = document.getElementById("busca").value.toLowerCase();
      const id = new URLSearchParams(window.location.search).get("id");
      const lista = document.getElementById("listaPropostas");
      const dados = propostas[id] || [];
      const statusPregao = pregoes[id] ? pregoes[id].status : "aberto";

      const existeVencedor = dados.some(p => p.vencedor);

      const filtradas = dados.filter(p => p.nome.toLowerCase().includes(termo) || p.cnpj.includes(termo));

      lista.innerHTML = filtradas.map((p, i) => {
        const podeEleger = p.status === 'aprovado' && !p.vencedor && !existeVencedor;
        return `
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div><strong>${p.nome}</strong> (${p.cnpj})
                ${p.vencedor ? '<span class="vencedor-badge">Vencedora</span>' : ''}
              </div>
              <div>Valor: ${p.valor}</div>
              <div>Status: ${p.status === 'aprovado' ? '<span class=\"aprovado\">Aprovado</span>' : 'Pendente'}</div>
            </div>
            <div>
              ${statusPregao === "aberto" && p.status === 'pendente' ? `
                <button class="btn btn-success btn-sm me-1" onclick="aprovar(${i}, '${id}')">Aprovar</button>
                <button class="btn btn-danger btn-sm" onclick="rejeitar(${i}, '${id}')">Rejeitar</button>
              ` : ''}
              ${podeEleger ? `
                <button class="btn btn-success btn-sm mt-1" onclick="elegerVencedor(${i}, '${id}')">Eleger Vencedor</button>
              ` : ''}
            </div>
          </li>
        `;
      }).join('');
    }

    window.onload = carregarPropostas;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
